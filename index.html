<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver and Blood: Advanced Interactive Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Gothic Harmony -->
    <!-- Application Structure Plan: A top-navigated, single-page application with distinct sections for different user goals. The structure starts with a high-level strategic summary, then allows users to dive into the core feature: an interactive, filterable Vassal Tier List. From there, users can explore related content like a deep dive into Game Mechanics (explained visually), practical Team Building examples (now expanded with a tabbed interface for different content types), detailed profiles of Top-Tier Vassals, and a new interactive Team Builder tool. The latest addition is the "Summoning Circle", a comprehensive gacha simulator and strategy guide. This non-linear, task-oriented structure was chosen because players have different needs: a new player might start with Mechanics, while a veteran might jump straight to the Team Builder or Gacha Simulator to theorycraft. The flow encourages exploration and makes finding specific information fast and intuitive. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Comprehensive Vassal Tier List -> Goal: Organize, Compare, Explore -> Viz/Presentation Method: Interactive HTML table with filters, search, and character portraits. -> Interaction: Dropdown filters for Tier, Faction, Class; text search; clickable rows to show detailed modal with larger image and new Synergy section. -> Justification: Transforms a static data table into a powerful, user-driven tool for strategic planning. -> Library/Method: Vanilla JavaScript, Tailwind CSS.
        - Report Info: Gacha System Mechanics -> Goal: Explain, Simulate, Strategize -> Viz/Presentation Method: A new "Summoning Circle" section with distinct components. -> Interaction: 1) Banner explanation text blocks. 2) Interactive Gacha Simulator with buttons for single/multi-pulls, a results display, and pity counters that update in real-time. -> Justification: This feature demystifies the gacha system, allows for risk-free experimentation, and provides actionable strategic advice on resource management, which is a critical aspect of the gacha genre. -> Library/Method: Vanilla JavaScript, HTML, Tailwind CSS.
        - Report Info: Team Building Principles -> Goal: Apply, Experiment -> Viz/Presentation Method: Interactive Team Builder tool. -> Interaction: Users select 5 Vassals; the UI provides real-time feedback on Faction bonuses, Blood Moon activation, and role balance. -> Justification: Allows players to actively apply the guide's principles and experiment with their own compositions in a hands-on way. -> Library/Method: Vanilla JavaScript.
        - Report Info: Content-Specific Needs -> Goal: Provide Examples -> Viz/Presentation Method: Expanded section with a tabbed UI to display 5+ team cards for different game modes (Campaign, Abyss, Raids). -> Interaction: Users click tabs to switch between content-specific team recommendations. -> Justification: Gives players concrete, optimized starting points for the game's most important PVE challenges without overwhelming them with a single long list. -> Library/Method: HTML, Tailwind CSS, Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1C1917; /* stone-900 */
            color: #F5F5F4; /* stone-100 */
        }
        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
        }
        .nav-link {
            transition: color 0.3s, border-color 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: #DC2626; /* red-600 */
            border-color: #DC2626;
        }
        .filter-button, .close-button, .builder-button, .tab-button, .summon-button {
             background-color: #57534E; /* stone-600 */
             color: #F5F5F4;
             transition: background-color 0.3s;
        }
        .filter-button:hover, .close-button:hover, .builder-button:hover, .tab-button:hover, .summon-button:hover, .tab-button.active {
            background-color: #991B1B; /* red-800 */
        }
        .summon-button:disabled {
            background-color: #44403C;
            cursor: not-allowed;
        }
        .tier-sss { background-color: #7f1d1d; border-left-color: #fca5a5; color: white; }
        .tier-s { background-color: #7c2d12; border-left-color: #fdba74; color: white; }
        .tier-a { background-color: #14532d; border-left-color: #86efac; color: white; }
        .tier-b { background-color: #1e3a8a; border-left-color: #93c5fd; color: white; }
        .tier-c { background-color: #374151; border-left-color: #9ca3af; color: white; }
        .tier-f { background-color: #1f2937; border-left-color: #6b7280; color: white; }
        .chart-container {
            position: relative; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px;
        }
        .modal { display: none; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .hero-section {
            background-image: linear-gradient(to top, rgba(28,25,23,1) 0%, rgba(28,25,23,0) 50%), url('https://play-lh.googleusercontent.com/gC9OvZOsAuJ7W0sO1MCujuo13541SqQKRbJF2f-kfik0ppbIojoQIwK9ycdfr3QHw6U=w648-h364-rw');
            background-size: cover; background-position: center;
        }
        .bg-card { background-color: #292524; } /* stone-800 */
        .bg-surface { background-color: #44403C; } /* stone-700 */
        .text-header { color: #fca5a5; } /* red-300 */
        .text-muted { color: #A8A29E; } /* stone-400 */
        .team-builder-slot.empty {
            border: 2px dashed #57534E;
        }
        .team-builder-vassal.selected {
            outline: 2px solid #DC2626;
            transform: scale(0.9);
            opacity: 0.5;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: grid; }

        .summon-result-card {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.5);
            opacity: 0;
            animation: reveal 0.5s forwards;
        }

        .summon-result-card.rarity-r { border: 2px solid #6b7280; }
        .summon-result-card.rarity-sr { border: 2px solid #3b82f6; box-shadow: 0 0 10px #3b82f6; }
        .summon-result-card.rarity-ssr { border: 2px solid #f59e0b; box-shadow: 0 0 15px #f59e0b; }

        @keyframes reveal {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header & Navigation -->
    <header class="bg-stone-900/80 backdrop-blur-sm sticky top-0 z-40 w-full shadow-lg">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-stone-100 font-cinzel">Silver & Blood Guide</a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#overview" class="nav-link text-stone-300 border-b-2 border-transparent pb-1">Overview</a>
                <a href="#tier-list" class="nav-link text-stone-300 border-b-2 border-transparent pb-1">Tier List</a>
                <a href="#team-compositions" class="nav-link text-stone-300 border-b-2 border-transparent pb-1">Compositions</a>
                <a href="#team-builder" class="nav-link text-stone-300 border-b-2 border-transparent pb-1">Team Builder</a>
                <a href="#summoning" class="nav-link text-stone-300 border-b-2 border-transparent pb-1">Summoning</a>
            </div>
            <button id="mobile-menu-button" class="md:hidden text-stone-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-stone-900">
             <a href="#overview" class="block text-stone-300 text-center py-2">Overview</a>
             <a href="#tier-list" class="block text-stone-300 text-center py-2">Tier List</a>
             <a href="#team-compositions" class="block text-stone-300 text-center py-2">Compositions</a>
             <a href="#team-builder" class="block text-stone-300 text-center py-2">Team Builder</a>
             <a href="#summoning" class="block text-stone-300 text-center py-2">Summoning</a>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="hero" class="hero-section h-[40vh] md:h-[50vh] flex items-end justify-center text-center p-8">
             <div class="text-white">
                <h1 class="text-4xl md:text-6xl lg:text-7xl font-bold text-shadow-lg">Conquer Minexus</h1>
                <p class="text-lg md:text-xl mt-2 max-w-2xl">Your ultimate interactive guide to mastering every Vassal and strategy.</p>
            </div>
        </section>

        <div class="container mx-auto p-4 md:p-8">
            <section id="overview" class="my-12 scroll-mt-24">
                <h2 class="text-4xl md:text-5xl font-bold text-center mb-4 text-header">The Path to Power</h2>
                <p class="max-w-3xl mx-auto text-center text-lg text-stone-300">This guide illuminates the true nature of strategy in *Silver and Blood*. True power is forged before the first blow is struck, in the meticulous preparation of your team. Mastering the intricate synergies between Vassals—their Factions, Classes, and Moon Phases—is the ultimate expression of skill.</p>
            </section>

            <section id="tier-list" class="my-16 scroll-mt-24">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-2 text-header">Interactive PVE Tier List</h2>
                <p class="text-center text-muted mb-8 max-w-2xl mx-auto">Use the filters to find the perfect unit. Click any Vassal to see a detailed breakdown of their role, strategic value, and key synergies.</p>
                <div class="bg-surface p-4 rounded-lg shadow-md mb-8 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                    <input type="text" id="name-search" placeholder="Search by name..." class="w-full p-2 rounded bg-stone-800 border border-stone-600 col-span-2 lg:col-span-2 text-white">
                    <div>
                        <label for="tier-filter" class="block text-sm font-medium text-muted mb-1">Tier</label>
                        <select id="tier-filter" class="w-full p-2 rounded bg-stone-800 border border-stone-600 text-white"><option value="all">All Tiers</option></select>
                    </div>
                    <div>
                        <label for="faction-filter" class="block text-sm font-medium text-muted mb-1">Faction</label>
                        <select id="faction-filter" class="w-full p-2 rounded bg-stone-800 border border-stone-600 text-white"><option value="all">All Factions</option></select>
                    </div>
                    <div>
                        <label for="class-filter" class="block text-sm font-medium text-muted mb-1">Class</label>
                        <select id="class-filter" class="w-full p-2 rounded bg-stone-800 border border-stone-600 text-white"><option value="all">All Classes</option></select>
                    </div>
                    <div>
                        <label for="moon-filter" class="block text-sm font-medium text-muted mb-1">Moon Phase</label>
                        <select id="moon-filter" class="w-full p-2 rounded bg-stone-800 border border-stone-600 text-white"><option value="all">All Phases</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-card p-4 rounded-lg shadow-lg overflow-x-auto">
                        <table class="w-full min-w-[600px]">
                            <thead class="border-b-2 border-stone-600"><tr>
                                <th class="p-3 text-left text-sm font-semibold text-muted w-2/5">Vassal</th>
                                <th class="p-3 text-left text-sm font-semibold text-muted">Tier</th>
                                <th class="p-3 text-left text-sm font-semibold text-muted">Faction</th>
                                <th class="p-3 text-left text-sm font-semibold text-muted">Class</th>
                                <th class="p-3 text-left text-sm font-semibold text-muted">Moon Phase</th>
                            </tr></thead>
                            <tbody id="tier-list-body"></tbody>
                        </table>
                    </div>
                    <div class="lg:col-span-1 bg-card p-4 rounded-lg shadow-lg flex flex-col justify-center">
                         <h3 class="text-xl font-bold text-center mb-4">Filtered Vassal Distribution</h3>
                         <div class="chart-container"><canvas id="distribution-chart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="team-compositions" class="my-16 scroll-mt-24">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-2 text-header">Optimized Team Compositions</h2>
                <p class="text-center text-muted mb-8 max-w-2xl mx-auto">Theory is nothing without practice. Here are optimized team formations for the game's key PVE challenges, demonstrating the principles of synergy in action.</p>
                
                <div class="mb-8 flex justify-center gap-2">
                    <button class="tab-button active px-4 py-2 rounded-md" data-tab="campaign">Campaign</button>
                    <button class="tab-button px-4 py-2 rounded-md" data-tab="abyss">Infinite Abyss</button>
                    <button class="tab-button px-4 py-2 rounded-md" data-tab="raids">Raids</button>
                </div>
                
                <div id="panel-campaign" class="tab-panel active grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="panel-abyss" class="tab-panel grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="panel-raids" class="tab-panel grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
            
            <section id="team-builder" class="my-16 scroll-mt-24">
                 <h2 class="text-3xl md:text-4xl font-bold text-center mb-2 text-header">Interactive Team Builder</h2>
                <p class="text-center text-muted mb-8 max-w-2xl mx-auto">Theorycraft your perfect squad. Select five Vassals from the roster below and see an instant analysis of your team's synergies and balance.</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Your Team</h3>
                        <div id="team-builder-slots" class="grid grid-cols-5 gap-2 mb-4"></div>
                        <h3 class="text-xl font-bold mb-4 mt-6">Synergy Analysis</h3>
                        <div id="team-analysis-report" class="space-y-3 text-stone-300 text-sm">
                           <p>Select Vassals to begin analysis.</p>
                        </div>
                        <button id="reset-team-button" class="builder-button w-full mt-6 py-2 rounded">Reset Team</button>
                    </div>
                    <div class="lg:col-span-2 bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Vassal Roster</h3>
                        <div id="team-builder-roster" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-[500px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </section>
            
            <section id="summoning" class="my-24 scroll-mt-24">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-2 text-header">The Summoning Circle</h2>
                <p class="text-center text-muted mb-8 max-w-2xl mx-auto">Understand the gacha system, learn how to spend your precious resources efficiently, and test your luck with our summoning simulator.</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                     <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center">Banner Strategy</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-lg text-header">Crimson Curse (Rate-Up Banner)</h4>
                                <p class="text-muted text-sm">This is the premium, limited-time banner where you should spend your primary summoning currency, **Tears of the Moon**. It features a specific SSS-Tier Vassal with a 50% chance of being the SSR you pull. Always save your Tears for a Vassal that will significantly improve your team.</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-header">Blue Dawn (Standard Banner)</h4>
                                <p class="text-muted text-sm">Blue Dawn is your typical standard banner in gacha games that uses **Soothing Scrolls** as its pull currency. You don’t want to spend Tears on this banner; at endgame you only pull on it using free Soothing Scrolls, maybe once or twice a week, to complete weekly missions or dailies, or if you’re a new player in desperate need of dupes or new characters to fill out your roster.</p>
                            </div>
                        </div>
                    </div>
                     <div class="bg-card p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center">Pity System & Events</h3>
                         <div class="space-y-4">
                            <div>
                                <h4 class="font-bold text-lg text-header">Pity System Explained</h4>
                                <p class="text-muted text-sm">Your luck is protected by a pity system. You are guaranteed to receive at least one **SR Vassal every 10 summons**, and one **SSR Vassal every 80 summons**. This pity count is separate for each banner type and resets to zero after you pull an SSR.</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-header">Current Event: Van Helsing Rate-Up</h4>
                                <p id="event-timer" class="text-muted text-sm">The "Crimson Curse" banner currently features **Van Helsing**. A top-tier positional damage dealer, he's a high-value target for any account aiming to dominate single-target content like raids. Banner ends: <span class="font-bold text-white">July 11, 2025</span>.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gacha Simulator -->
                <div class="bg-card p-6 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-center">Gacha Simulator</h3>
                    <div class="flex justify-center gap-4 mb-6">
                        <button id="sim-banner-standard" class="tab-button px-4 py-2 rounded-md">Blue Dawn (Standard)</button>
                        <button id="sim-banner-rateup" class="tab-button active px-4 py-2 rounded-md">Crimson Curse (Rate-Up)</button>
                    </div>
                    <div class="bg-surface p-4 rounded-lg text-center mb-6">
                        <p class="text-lg mb-2">Pity Counters</p>
                        <div class="flex justify-center gap-8 text-sm">
                            <p>SR Pity: <strong id="sr-pity-counter" class="text-blue-400">0</strong>/10</p>
                            <p>SSR Pity: <strong id="ssr-pity-counter" class="text-yellow-400">0</strong>/80</p>
                            <p>Tears Spent: <strong id="tears-spent-counter" class="text-red-400">0</strong></p>
                        </div>
                    </div>
                    <div id="summon-results-display" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-6 min-h-[150px]">
                        <!-- Summon results appear here -->
                    </div>
                    <div class="flex justify-center gap-4">
                        <button id="summon-1-btn" class="summon-button px-6 py-3 rounded-lg font-bold">Summon x1</button>
                        <button id="summon-10-btn" class="summon-button px-6 py-3 rounded-lg font-bold">Summon x10</button>
                    </div>
                </div>
            </section>

        </div>
    </main>
    
    <footer class="bg-stone-900 text-stone-500 text-center p-6 mt-16">
        <p>This interactive guide is based on the "Silver and Blood: A Strategic Analysis" report. Data sourced from pre-release and community analysis.</p>
    </footer>

    <div id="vassal-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-card w-full max-w-2xl mx-auto rounded-lg shadow-xl overflow-hidden border border-stone-700">
            <div id="modal-content" class="p-6"></div>
            <div class="bg-surface p-4 text-right">
                 <button id="modal-close-button" class="close-button px-4 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

<script>
const vassalData = [
    { id:1, tier: 'SSS', name: 'Acappella', rarity: 'SSR', faction: 'Church', class: 'Enchanter', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/acappella.webp' },
    { id:2, tier: 'SSS', name: 'Agares: Incendiary', rarity: 'SSR+', faction: 'Ancestors', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/agares-incendiary.webp' },
    { id:3, tier: 'SSS', name: 'Ami: Transcendent', rarity: 'SSR+', faction: 'Ancestors', class: 'Guardian', moon: 'Waxing Moon', image: 'https://lootandwaifus.com/characters/silverandblood/ami-transcendent.webp' },
    { id:4, tier: 'SSS', name: 'Lamia', rarity: 'SSR', faction: 'Kingdom', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/lamia.webp' },
    { id:5, tier: 'SSS', name: 'Noah: Transcendent', rarity: 'SSR+', faction: 'Ancestors', class: 'Hunter', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/noah-transcendent.webp' },
    { id:6, tier: 'SSS', name: 'Seth', rarity: 'SSR', faction: 'Ancestors', class: 'Enchanter', moon: 'Waxing Moon', image: 'https://lootandwaifus.com/characters/silverandblood/seth.webp' },
    { id:7, tier: 'SSS', name: 'Van Helsing', rarity: 'SSR', faction: 'Church', class: 'Hunter', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/van-helsing.webp' },
    { id:8, tier: 'S', name: 'Ami', rarity: 'SSR', faction: 'Kingdom', class: 'Enchanter', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/ami.webp' },
    { id:9, tier: 'S', name: 'Bella', rarity: 'SSR', faction: 'Bloodborn', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/bella.webp' },
    { id:10, tier: 'S', name: 'Darcias', rarity: 'SSR', faction: 'Church', class: 'Warrior', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/darcias.webp' },
    { id:11, tier: 'S', name: 'Gilrain', rarity: 'SSR', faction: 'Kingdom', class: 'Assassin', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/gilrain.webp' },
    { id:12, tier: 'S', name: 'Hati: Transcendent', rarity: 'SSR+', faction: 'Ancestors', class: 'Warrior', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/hati-transcendent.webp' },
    { id:13, tier: 'A', name: 'Hati', rarity: 'SSR', faction: 'Kingdom', class: 'Assassin', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/hati.webp' },
    { id:14, tier: 'A', name: 'Jestel', rarity: 'SR', faction: 'Bloodborn', class: 'Guardian', moon: 'Waxing Moon', image: 'https://lootandwaifus.com/characters/silverandblood/jestel.webp' },
    { id:15, tier: 'A', name: 'Selena', rarity: 'SR', faction: 'Church', class: 'Hunter', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/selena.webp' },
    { id:16, tier: 'B', name: 'Aiona', rarity: 'SR', faction: 'Bloodborn', class: 'Enchanter', moon: 'Waxing Moon', image: 'https://lootandwaifus.com/characters/silverandblood/aiona.webp' },
    { id:17, tier: 'B', name: 'Empousa', rarity: 'SR', faction: 'Bloodborn', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/empousa.webp' },
    { id:18, tier: 'B', name: 'Joan', rarity: 'SR', faction: 'Church', class: 'Warrior', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/joan.webp' },
    { id:19, tier: 'S', name: 'Spectral Gilrain', rarity: 'SSR', faction: 'Bloodborn', class: 'Assassin', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/spectral-gilrain.webp' },
    { id:20, tier: 'A', name: 'Augustine', rarity: 'SSR', faction: 'Bloodborn', class: 'Warrior', moon: 'Half Moon', image: 'https://lootandwaifus.com/characters/silverandblood/augustine.webp' },
    { id:21, tier: 'A', name: 'Cecia', rarity: 'SSR', faction: 'Kingdom', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/cecia.webp' },
    { id:22, tier: 'S', name: 'Limine', rarity: 'SSR', faction: 'Ancestors', class: 'Sorcerer', moon: 'Full Moon', image: 'https://lootandwaifus.com/characters/silverandblood/limine.webp' },
    // Adding R-tier vassals for gacha pool
    { id: 101, tier: 'F', name: 'Guard', rarity: 'R', faction: 'Kingdom', class: 'Warrior', moon: 'Half Moon', image: 'https://placehold.co/150x150/6b7280/1f2937?text=Guard' },
    { id: 102, tier: 'F', name: 'Acolyte', rarity: 'R', faction: 'Church', class: 'Enchanter', moon: 'Waxing Moon', image: 'https://placehold.co/150x150/6b7280/1f2937?text=Acolyte' },
    { id: 103, tier: 'F', name: 'Scout', rarity: 'R', faction: 'Bloodborn', class: 'Hunter', moon: 'Full Moon', image: 'https://placehold.co/150x150/6b7280/1f2937?text=Scout' },
    { id: 104, tier: 'F', name: 'Initiate', rarity: 'R', faction: 'Ancestors', class: 'Sorcerer', moon: 'Half Moon', image: 'https://placehold.co/150x150/6b7280/1f2937?text=Initiate' }
];

const vassalDetails = {
    'Joan': 'Discrepancy in ranking exists. Ranked SSS elsewhere, likely for PvP or early-game dominance. For PVE end-game, she is a solid early investment but falls off compared to specialized tanks. A versatile and resilient frontline unit.',
    'Van Helsing': 'Exemplifies positional strategy. Deals significantly more damage if no allies are in the two tiles in front of him, rewarding careful, high-risk team formations.',
    'Noah: Transcendent': 'Premier physical DPS who can also summon allies. These summons provide immense tactical value as blockers, decoys, or extra damage sources, offering unparalleled board control.',
    'Agares: Incendiary': 'The game\'s top AoE magical DPS. Essential for clearing waves of enemies quickly and efficiently. His high survivability makes him less reliant on constant protection.',
    'Acappella': 'The cornerstone of any top-tier team. Provides powerful healing and a suite of offensive and defensive buffs that multiply the effectiveness of the entire team. Arguably the highest priority Vassal to acquire.',
};

const vassalSynergies = {
    'Acappella': [ { name: 'Agares: Incendiary', reason: 'Provides the sustain needed for Agares to unleash his full AoE potential without fear.'}, { name: 'Ami: Transcendent', reason: 'Keeps the primary tank alive, forming an unbreakable defensive core.'} ],
    'Agares: Incendiary': [ { name: 'Acappella', reason: 'Her buffs and healing allow him to stay on the field longer, maximizing his damage output.' }, { name: 'Seth', reason: 'Dual-support from Seth ensures Agares can survive heavy focus fire while wiping enemy teams.' } ],
    'Van Helsing': [ { name: 'Ami: Transcendent', reason: 'Ami can hold the line while Van Helsing takes a solo forward position for his damage bonus.'}, { name: 'Noah: Transcendent', reason: 'Noah\'s summons can be placed strategically to protect Van Helsing without interfering with his positional passive.'} ]
};

const teamComps = {
    campaign: [
        { title: 'Standard & Sustainable', focus: 'Sustain & AoE', desc: 'A balanced team for clearing waves and handling diverse enemy types. Strong healing and AoE are key.', members: ['Joan', 'Agares: Incendiary', 'Selena', 'Acappella', 'Seth'] },
        { title: 'F2P Blood Moon Core', focus: 'Early Game Power', desc: 'Uses accessible Vassals to activate the crucial Blood Moon buff, giving new players a significant advantage.', members: ['Joan', 'Hati', 'Empousa', 'Aiona', 'Selena'] },
        { title: 'Ancestors Might', focus: 'Faction Dominance', desc: 'A powerful 3-2 Ancestors/Church split that combines top-tier AoE, summons, and healing for overwhelming force.', members: ['Ami: Transcendent', 'Agares: Incendiary', 'Noah: Transcendent', 'Acappella', 'Seth'] },
        { title: 'Church Resilience', focus: 'Extreme Survival', desc: 'This team focuses on outlasting any enemy with a strong Church core, featuring a tough tank and multiple healers/buffers.', members: ['Joan', 'Darcias', 'Van Helsing', 'Selena', 'Acappella'] },
        { title: 'Kingdom\'s Gambit', focus: 'Mixed Damage & Control', desc: 'Leverages the strong DPS and support options from the Kingdom faction, creating a versatile and hard-hitting lineup.', members: ['Ami', 'Gilrain', 'Hati', 'Lamia', 'Cecia'] }
    ],
    abyss: [
        { title: 'Burst & Control', focus: 'Burst Damage & Summons', desc: 'Maximum damage output to beat timers, with summons for tactical blocking and control on tough floors.', members: ['Ami: Transcendent', 'Noah: Transcendent', 'Spectral Gilrain', 'Acappella', 'Lamia'] },
        { title: 'Full Ancestors Assault', focus: 'Pure Faction Power', desc: 'Commits to a 5-man Ancestors team for the maximum faction bonus, resulting in incredible stats and damage.', members: ['Ami: Transcendent', 'Hati: Transcendent', 'Agares: Incendiary', 'Noah: Transcendent', 'Seth'] },
        { title: 'Mage Annihilation', focus: 'AoE Magical Burst', desc: 'Stacks the game\'s best Sorcerers to obliterate enemy waves with overwhelming magical power. Requires strong support.', members: ['Ami: Transcendent', 'Agares: Incendiary', 'Lamia', 'Limine', 'Acappella'] },
        { title: 'Assassin\'s Strike', focus: 'Backline Elimination', desc: 'Uses multiple assassins to bypass the enemy frontline and quickly eliminate high-priority threats like healers or mages.', members: ['Ami: Transcendent', 'Gilrain', 'Spectral Gilrain', 'Hati', 'Acappella'] },
        { title: 'Bloodborn Fury', focus: 'High-Risk Offense', desc: 'A team built around the aggressive Bloodborn faction, relying on their powerful offensive capabilities to win quickly.', members: ['Jestel', 'Augustine', 'Bella', 'Spectral Gilrain', 'Aiona'] }
    ],
    raids: [
        { title: 'Positional Supremacy', focus: 'Single-Target & Survival', desc: 'Built to burn down a single, high-health boss. Positional damage and dual healers are crucial for survival.', members: ['Ami: Transcendent', 'Van Helsing', 'Lamia', 'Acappella', 'Seth'] },
        { title: 'The Unbreakable Wall', focus: 'Maximum Sustain', desc: 'A hyper-defensive setup with a top-tier tank and dual healers, designed to survive the most devastating boss attacks.', members: ['Ami: Transcendent', 'Agares: Incendiary', 'Noah: Transcendent', 'Acappella', 'Seth'] },
        { title: 'Ultimate Firestorm', focus: 'Blood Moon Spam', desc: 'This team perfectly aligns the Blood Moon and leverages Vassals with high damage ultimates to create a constant barrage of power.', members: ['Ami: Transcendent', 'Van Helsing', 'Lamia', 'Acappella', 'Noah: Transcendent'] },
        { title: 'Church\'s Holy Fire', focus: 'Factional DPS', desc: 'A 3-2 Church/Ancestors team focusing on the raw single-target damage of Van Helsing, amplified by strong Church support.', members: ['Ami: Transcendent', 'Van Helsing', 'Darcias', 'Acappella', 'Seth'] },
        { title: 'Assassin’s Gambit', focus: 'High Crit Damage', desc: 'Focuses on the high single-target burst of assassins, ideal for bosses without minions. Needs strong healing to survive.', members: ['Ami: Transcendent', 'Gilrain', 'Spectral Gilrain', 'Acappella', 'Seth'] }
    ]
};

document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONFIG ---
    const elements = {
        tierListBody: document.getElementById('tier-list-body'), nameSearch: document.getElementById('name-search'),
        tierFilter: document.getElementById('tier-filter'), factionFilter: document.getElementById('faction-filter'),
        classFilter: document.getElementById('class-filter'), moonFilter: document.getElementById('moon-filter'),
        modal: document.getElementById('vassal-modal'), modalContent: document.getElementById('modal-content'),
        modalCloseButton: document.getElementById('modal-close-button'), mobileMenuButton: document.getElementById('mobile-menu-button'),
        mobileMenu: document.getElementById('mobile-menu'), teamBuilderSlots: document.getElementById('team-builder-slots'),
        teamAnalysisReport: document.getElementById('team-analysis-report'), teamBuilderRoster: document.getElementById('team-builder-roster'),
        resetTeamButton: document.getElementById('reset-team-button'),
        tabs: document.querySelectorAll('.tab-button'), panels: document.querySelectorAll('.tab-panel'),
        simBannerStandard: document.getElementById('sim-banner-standard'), simBannerRateup: document.getElementById('sim-banner-rateup'),
        srPityCounter: document.getElementById('sr-pity-counter'), ssrPityCounter: document.getElementById('ssr-pity-counter'),
        tearsSpentCounter: document.getElementById('tears-spent-counter'), summonResultsDisplay: document.getElementById('summon-results-display'),
        summon1Btn: document.getElementById('summon-1-btn'), summon10Btn: document.getElementById('summon-10-btn')
    };

    const state = {
        tierOrder: ['SSS', 'S', 'A', 'B', 'C', 'F'],
        factionOrder: ['Ancestors', 'Church', 'Bloodborn', 'Kingdom'],
        classOrder: ['Guardian', 'Warrior', 'Assassin', 'Hunter', 'Sorcerer', 'Enchanter'],
        moonOrder: ['Waxing Moon', 'Half Moon', 'Full Moon'],
        team: [],
        gacha: {
            isRateUp: true, srPity: 0, ssrPity: 0, tearsSpent: 0,
            pools: {
                ssr: vassalData.filter(v => v.rarity.includes('SSR')),
                sr: vassalData.filter(v => v.rarity === 'SR'),
                r: vassalData.filter(v => v.rarity === 'R')
            },
            rates: { ssr: 0.025, sr: 0.15 },
            rateUpVassal: vassalData.find(v => v.name === 'Van Helsing')
        }
    };
    
    let distributionChart;

    // --- INITIALIZATION ---
    function initialize() {
        populateFilters();
        filterAndRender();
        initTeamBuilder();
        initTeamComps();
        initGachaSimulator();
        updateActiveNav();
        window.addEventListener('scroll', updateActiveNav);
    }
    
    function updateActiveNav() {
        let currentSection = '';
        const sections = document.querySelectorAll('main section');
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            if (window.scrollY >= sectionTop - 100) {
                currentSection = section.getAttribute('id');
            }
        });

        const navLinks = document.querySelectorAll('header .nav-link');
        navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${currentSection}`) {
                link.classList.add('active');
            }
        });
    }

    // --- TIER LIST & MODAL ---
    function populateFilters() {
        state.tierOrder.forEach(tier => { elements.tierFilter.innerHTML += `<option value="${tier}">${tier}</option>`; });
        state.factionOrder.forEach(faction => { elements.factionFilter.innerHTML += `<option value="${faction}">${faction}</option>`; });
        state.classOrder.forEach(cls => { elements.classFilter.innerHTML += `<option value="${cls}">${cls}</option>`; });
        state.moonOrder.forEach(moon => { elements.moonFilter.innerHTML += `<option value="${moon}">${moon}</option>`; });
    }

    function renderTable(filteredData) {
        elements.tierListBody.innerHTML = '';
        if (filteredData.length === 0) {
            elements.tierListBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-muted">No Vassals match filters.</td></tr>`;
            return;
        }
        filteredData.sort((a, b) => {
            const tierDiff = state.tierOrder.indexOf(a.tier) - state.tierOrder.indexOf(b.tier);
            return tierDiff !== 0 ? tierDiff : a.name.localeCompare(b.name);
        });
        filteredData.forEach(vassal => {
            const row = document.createElement('tr');
            row.className = `border-b border-stone-700 hover:bg-stone-700/50 cursor-pointer tier-${vassal.tier.toLowerCase()} border-l-4 align-middle`;
            row.innerHTML = `<td class="p-3"><div class="flex items-center"><img src="${vassal.image}" alt="${vassal.name}" class="w-12 h-12 rounded-md mr-4 object-cover shadow-sm" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';"><div><div class="font-bold">${vassal.name}</div><div class="text-sm text-muted">${vassal.rarity}</div></div></div></td><td class="p-3"><span class="font-bold text-sm">${vassal.tier}</span></td><td class="p-3">${vassal.faction}</td><td class="p-3">${vassal.class}</td><td class="p-3">${vassal.moon}</td>`;
            row.addEventListener('click', () => showModal(vassal));
            elements.tierListBody.appendChild(row);
        });
    }
    
    function showModal(vassal) {
        elements.modal.style.display = 'flex';
        const detailText = vassalDetails[vassal.name] || 'A capable Vassal effective in their designated role.';
        const synergies = vassalSynergies[vassal.name];
        let synergyHTML = '';
        if (synergies) {
            synergyHTML = `<h4 class="font-bold text-lg mt-4 mb-2 text-header">Key Synergies</h4><div class="space-y-2">`;
            synergies.forEach(syn => {
                const partner = vassalData.find(v => v.name === syn.name);
                if(partner){
                    synergyHTML += `<div class="flex items-center bg-surface p-2 rounded-md"><img src="${partner.image}" alt="${partner.name}" class="w-8 h-8 rounded-full mr-3" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';"><div><p class="font-bold text-sm">${partner.name}</p><p class="text-xs text-muted">${syn.reason}</p></div></div>`;
                }
            });
            synergyHTML += `</div>`;
        }
        elements.modalContent.innerHTML = `<div class="flex flex-col md:flex-row gap-6"><div class="md:w-1/3 flex-shrink-0"><img src="${vassal.image}" alt="${vassal.name}" class="w-full h-auto rounded-lg shadow-lg object-cover" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';"></div><div class="flex-grow"><h3 class="text-3xl font-bold mb-2 font-cinzel text-white">${vassal.name}</h3><div class="flex flex-wrap gap-x-4 gap-y-2 mb-4 text-muted"><span><strong>Tier:</strong> ${vassal.tier}</span><span><strong>Faction:</strong> ${vassal.faction}</span><span><strong>Class:</strong> ${vassal.class}</span><span><strong>Moon:</strong> ${vassal.moon}</span></div><h4 class="font-bold text-lg mt-4 mb-2 text-header">Strategic Analysis</h4><p class="text-stone-300">${detailText}</p>${synergyHTML}</div></div>`;
    }

    function hideModal() { elements.modal.style.display = 'none'; }

    function renderChart(filteredData) {
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        const distribution = filteredData.reduce((acc, vassal) => {
            const key = elements.factionFilter.value !== 'all' ? vassal.class : vassal.faction;
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        if (distributionChart) { distributionChart.destroy(); }
        Chart.defaults.color = '#d6d3d1';
        distributionChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(distribution), datasets: [{ label: 'Vassal Distribution', data: Object.values(distribution), backgroundColor: [ '#7f1d1d', '#7c2d12', '#14532d', '#1e3a8a', '#374151', '#4b5563'], borderColor: '#292524', borderWidth: 4, }]}, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    }

    function filterAndRender() {
        const queries = { name: elements.nameSearch.value.toLowerCase(), tier: elements.tierFilter.value, faction: elements.factionFilter.value, class: elements.classFilter.value, moon: elements.moonFilter.value };
        const filtered = vassalData.filter(v => (queries.name === '' || v.name.toLowerCase().includes(queries.name)) && (queries.tier === 'all' || v.tier === queries.tier) && (queries.faction === 'all' || v.faction === queries.faction) && (queries.class === 'all' || v.class === queries.class) && (queries.moon === 'all' || v.moon === queries.moon) );
        renderTable(filtered);
        renderChart(filtered);
    }
    
    // --- TEAM BUILDER ---
    function initTeamBuilder() {
        renderTeamSlots(); renderRoster();
        elements.resetTeamButton.addEventListener('click', () => { state.team = []; updateTeamBuilder(); });
    }
    function renderTeamSlots() {
        elements.teamBuilderSlots.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            const slot = document.createElement('div');
            slot.className = 'team-builder-slot empty aspect-square flex items-center justify-center rounded-lg bg-surface';
            if(state.team[i]){
                const vassal = state.team[i];
                slot.classList.remove('empty');
                slot.innerHTML = `<img src="${vassal.image}" alt="${vassal.name}" class="w-full h-full object-cover rounded-lg" title="${vassal.name}" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';">`;
                slot.addEventListener('click', () => removeVassalFromTeam(vassal.id));
            }
            elements.teamBuilderSlots.appendChild(slot);
        }
    }
    function renderRoster() {
        elements.teamBuilderRoster.innerHTML = '';
        vassalData.forEach(vassal => {
            const rosterItem = document.createElement('div');
            rosterItem.className = 'team-builder-vassal cursor-pointer transition-transform duration-200 hover:scale-110';
            rosterItem.innerHTML = `<img src="${vassal.image}" alt="${vassal.name}" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';">`;
            if (state.team.some(v => v.id === vassal.id)) { rosterItem.classList.add('selected'); }
            rosterItem.addEventListener('click', () => addVassalToTeam(vassal.id));
            elements.teamBuilderRoster.appendChild(rosterItem);
        });
    }
    function addVassalToTeam(id) {
        if (state.team.length < 5 && !state.team.some(v => v.id === id)) {
            const vassal = vassalData.find(v => v.id === id);
            state.team.push(vassal); updateTeamBuilder();
        }
    }
    function removeVassalFromTeam(id) { state.team = state.team.filter(v => v.id !== id); updateTeamBuilder(); }
    function updateTeamBuilder() { renderTeamSlots(); renderRoster(); analyzeTeam(); }
    function analyzeTeam() {
        if (state.team.length === 0) { elements.teamAnalysisReport.innerHTML = '<p class="text-muted">Select Vassals to begin analysis.</p>'; return; }
        let report = '';
        const factions = state.team.reduce((acc, v) => { acc[v.faction] = (acc[v.faction] || 0) + 1; return acc; }, {});
        report += `<div><strong class="text-header">Faction Synergy:</strong> `;
        const factionBonuses = Object.entries(factions).filter(([_, count]) => count >= 2);
        if(factionBonuses.length > 0) { report += factionBonuses.map(([faction, count]) => `${faction} x${count}`).join(', '); } else { report += `<span class="text-yellow-400">None Active</span>`; }
        report += `</div>`;
        const moons = new Set(state.team.map(v => v.moon));
        report += `<div><strong class="text-header">Blood Moon:</strong> `;
        if (moons.has('Waxing Moon') && moons.has('Half Moon') && moons.has('Full Moon')) { report += `<span class="text-green-400">ACTIVATED!</span>`; } else { report += `<span class="text-yellow-400">Not Active</span>`; }
        report += `</div>`;
        const roles = state.team.reduce((acc, v) => { acc[v.class] = (acc[v.class] || 0) + 1; return acc; }, {});
        report += `<div><strong class="text-header">Role Balance:</strong> ${Object.entries(roles).map(([role, count]) => `${role} x${count}`).join(', ')}</div>`;
        let summary = '';
        const tankCount = roles['Guardian'] || 0; const healerCount = roles['Enchanter'] || 0;
        const dpsCount = (roles['Warrior'] || 0) + (roles['Assassin'] || 0) + (roles['Hunter'] || 0) + (roles['Sorcerer'] || 0);
        if (tankCount === 0) summary += '<li>No Guardian for protection.</li>';
        if (healerCount === 0) summary += '<li>No Enchanter for healing.</li>';
        if (dpsCount < 2) summary += '<li>Low damage output.</li>';
        if(summary !== '') report += `<div><strong class="text-header">Summary:</strong><ul class="list-disc list-inside text-yellow-400">${summary}</ul></div>`;
        elements.teamAnalysisReport.innerHTML = report;
    }
    
    // --- TEAM COMPS ---
    function initTeamComps() {
        for (const [category, teams] of Object.entries(teamComps)) {
            const panel = document.getElementById(`panel-${category}`);
            if (!panel) continue;
            panel.innerHTML = teams.map(team => {
                const membersHTML = team.members.map(memberName => {
                    const vassal = vassalData.find(v => v.name === memberName);
                    return vassal ? `<div class="flex items-center text-sm"><img src="${vassal.image}" alt="${vassal.name}" class="w-6 h-6 rounded-full mr-2 object-cover" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';"><span>${vassal.name}</span></div>` : '';
                }).join('');
                return `<div class="bg-surface p-6 rounded-lg shadow-lg"><h3 class="text-lg font-bold mb-1">${team.title}</h3><p class="text-sm text-header mb-3">${team.focus}</p><p class="text-muted text-sm mb-4">${team.desc}</p><div class="space-y-2">${membersHTML}</div></div>`;
            }).join('');
        }
    }
    
    function handleTabClick(e) {
        elements.tabs.forEach(tab => tab.classList.remove('active'));
        elements.panels.forEach(panel => panel.classList.remove('active'));
        const tabButton = e.currentTarget;
        tabButton.classList.add('active');
        document.getElementById(`panel-${tabButton.dataset.tab}`).classList.add('active');
    }
    
    // --- GACHA SIMULATOR ---
    function initGachaSimulator() {
        elements.simBannerStandard.addEventListener('click', () => switchGachaBanner(false));
        elements.simBannerRateup.addEventListener('click', () => switchGachaBanner(true));
        elements.summon1Btn.addEventListener('click', () => performSummon(1));
        elements.summon10Btn.addEventListener('click', () => performSummon(10));
        updateGachaUI();
    }

    function switchGachaBanner(isRateUp) {
        state.gacha.isRateUp = isRateUp;
        elements.simBannerStandard.classList.toggle('active', !isRateUp);
        elements.simBannerRateup.classList.toggle('active', isRateUp);
        state.gacha.srPity = 0; state.gacha.ssrPity = 0; state.gacha.tearsSpent = 0;
        updateGachaUI();
        elements.summonResultsDisplay.innerHTML = '';
    }
    
    function performSummon(count) {
        let results = [];
        let hasGuaranteedSR = false;

        for(let i=0; i < count; i++) {
            state.gacha.srPity++;
            state.gacha.ssrPity++;
            state.gacha.tearsSpent++;

            let pull;
            const rand = Math.random();

            if (state.gacha.ssrPity === 80) {
                if (state.gacha.isRateUp && Math.random() < 0.5) {
                    pull = state.gacha.rateUpVassal;
                } else {
                    pull = getRandomVassal('ssr');
                }
                state.gacha.ssrPity = 0;
            } else if (state.gacha.srPity === 10) {
                 pull = getRandomVassal('sr');
                 hasGuaranteedSR = true;
            } else if (rand < state.gacha.rates.ssr) {
                 if (state.gacha.isRateUp && Math.random() < 0.5) {
                    pull = state.gacha.rateUpVassal;
                } else {
                    pull = getRandomVassal('ssr');
                }
                state.gacha.ssrPity = 0;
            } else if (rand < state.gacha.rates.ssr + state.gacha.rates.sr) {
                pull = getRandomVassal('sr');
            } else {
                pull = getRandomVassal('r');
            }
            results.push(pull);
            if(pull.rarity.includes('SR')) state.gacha.srPity = 0;
        }

        if (count === 10 && !results.some(v => v.rarity.includes('SR')) && !hasGuaranteedSR) {
             results[results.length -1] = getRandomVassal('sr');
             const lastPullWasSSR = results[results.length-1].rarity.includes('SSR');
             if(lastPullWasSSR) {
                 state.gacha.ssrPity = 0;
             }
             state.gacha.srPity = 0;
        }

        displaySummonResults(results);
        updateGachaUI();
    }

    function getRandomVassal(rarity) {
        const pool = state.gacha.pools[rarity.toLowerCase()];
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function displaySummonResults(results) {
        elements.summonResultsDisplay.innerHTML = '';
        results.sort((a,b) => {
            const rarityOrder = {'SSR':0, 'SSR+': 0, 'SR':1, 'R':2};
            const aRarity = a.rarity.includes('SSR') ? 'SSR' : a.rarity;
            const bRarity = b.rarity.includes('SSR') ? 'SSR' : b.rarity;
            return rarityOrder[aRarity] - rarityOrder[bRarity];
        });

        results.forEach((vassal, index) => {
            const card = document.createElement('div');
            const rarityClass = vassal.rarity.includes('SSR') ? 'ssr' : vassal.rarity.toLowerCase();
            card.className = `summon-result-card bg-surface rounded-lg p-2 text-center flex flex-col items-center justify-center rarity-${rarityClass}`;
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `
                <img src="${vassal.image}" class="h-16 w-16 object-cover rounded-md mb-2" onerror="this.onerror=null;this.src='https://lootandwaifus.com/characters/silverandblood/default.webp';">
                <p class="text-xs font-bold">${vassal.name}</p>
                <p class="text-xs text-muted">${vassal.rarity}</p>
            `;
            elements.summonResultsDisplay.appendChild(card);
        });
    }

    function updateGachaUI() {
        elements.srPityCounter.textContent = state.gacha.srPity;
        elements.ssrPityCounter.textContent = state.gacha.ssrPity;
        elements.tearsSpentCounter.textContent = state.gacha.tearsSpent;
    }

    // --- EVENT LISTENERS & FINAL SETUP ---
    initialize();
    [elements.nameSearch, elements.tierFilter, elements.factionFilter, elements.classFilter, elements.moonFilter].forEach(el => { el.addEventListener('input', filterAndRender); });
    elements.modalCloseButton.addEventListener('click', hideModal);
    elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) hideModal(); });
    elements.mobileMenuButton.addEventListener('click', () => { elements.mobileMenu.classList.toggle('hidden'); });
    elements.tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
});
</script>
</body>
</html>
